<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Step 4 - Human-in-the-Loop Confidence</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
     <script src="assets/templates.js"></script>
  <div id="imports"></div>
  <style>
    .confidence-btn {
      width: 100%;
      font-size: 1.25rem;
      padding: 1rem;
    }
    .btn-high { background-color: #198754; color: white; }
    .btn-high:hover { background-color: #146c43; color: white; }
    .btn-low { background-color: #0d6efd; color: white; }
    .btn-low:hover { background-color: #0a58ca; color: white; }
    .explanation { font-size: 1.1rem; margin-bottom: 2rem; }
    .upload-section { margin-top: 2rem; }
    .dropzone {
      border: 2px dashed #0d6efd;
      border-radius: 0.375rem;
      padding: 2rem;
      text-align: center;
      color: #0d6efd;
      cursor: pointer;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .dropzone.dragover {
      background-color: #e9f0ff;
      border-color: #0a58ca;
      color: #0a58ca;
    }
    .dropzone input[type="file"] { display: none; }
  </style>
</head>

<body class="bg-light" style="height: 100vh;">
  <div id="header"></div>

  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-10 bg-white p-5 rounded shadow-sm">
        <h2 class="mb-4 text-center">Start Looping</h2>

        <div class="explanation">
          <p>Until now, only the automatic selection has been performed. The confidence threshold has been set and
            allows including or excluding studies based on the criteria scores.</p>
          <p>Now, we will begin the <strong>Human-in-the-Loop (HIL)</strong> phase. Please select a confidence level:</p>
          <ul>
            <li><strong>Low confidence</strong>: another LLM will assist. Recommended for pilot tests.</li>
            <li><strong>High confidence</strong>: careful human review. Recommended for final studies.</li>
          </ul>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-6"><button id="btn-low" class="btn confidence-btn btn-low">Low Confidence</button></div>
          <div class="col-md-6"><button id="btn-high" class="btn confidence-btn btn-high">High Confidence</button></div>
        </div>

        <div class="upload-section">
          <h5>Upload first_llm_screnning_assets.ZIP</h5>
          <p class="text-muted">Upload ZIP containing JSON files: metadata.json, included.json, excluded.json, fullRunStudies.json.</p>

          <label for="uploadZip" class="dropzone" id="dropzone">
            Drag & Drop ZIP here, or click to select
            <input type="file" id="uploadZip" accept=".zip" />
          </label>

          <div id="uploadStatus" class="text-success mt-3" style="display: none;"></div>
          <div id="uploadError" class="text-danger mt-3" style="display: none;"></div>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script>
    // Confidence buttons
    document.getElementById('btn-low').addEventListener('click', () => {
      localStorage.setItem('hilConfidenceLevel', 'low');
      window.location.href = 'hil-low.html';
    });
    document.getElementById('btn-high').addEventListener('click', () => {
      localStorage.setItem('hilConfidenceLevel', 'high');
      window.location.href = 'hil-high.html';
    });

    // ZIP upload
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('uploadZip');
    const status = document.getElementById('uploadStatus');
    const error = document.getElementById('uploadError');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => {
      dropzone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); });
    });
    ['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, () => dropzone.classList.add('dragover')));
    ['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, () => dropzone.classList.remove('dragover')));

    dropzone.addEventListener('drop', e => { if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
    dropzone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => { if(fileInput.files.length) handleFile(fileInput.files[0]); });

    async function handleFile(file) {
      status.style.display = 'none'; error.style.display = 'none'; error.textContent = '';
      if(!file.name.toLowerCase().endsWith('.zip')) return errorMessage('Please upload a valid ZIP file.');

      try {
        const zip = await JSZip.loadAsync(file);
        const files = { 'metadata.json':'metadata', 'included.json':'includedStudies', 'excluded.json':'excludedStudies', 'fullRunStudies.json':'fullRunStudies' };
        let loaded = 0;

        for(const [fname,key] of Object.entries(files)){
          if(zip.file(fname)){
            const content = await zip.file(fname).async('string');
            try { JSON.parse(content); localStorage.setItem(key, content); loaded++; } 
            catch { return errorMessage(`${fname} is not valid JSON.`); }
          }
        }
        if(loaded>0) statusMessage(`✅ Loaded ${loaded} file(s) successfully.`);
        else errorMessage('No valid JSON files found in ZIP.');
      } catch(err){ errorMessage('Failed to read ZIP file.'); }
    }

    function errorMessage(msg){ error.style.display='block'; error.textContent='❌ '+msg; }
    function statusMessage(msg){ status.style.display='block'; status.textContent=msg; }
  </script>
</body>

<script>
  $("#imports").load("components/imports.html");
  $("#header").load("components/header.html");
</script>
</html>
