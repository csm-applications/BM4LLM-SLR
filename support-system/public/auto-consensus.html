<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Auto-Consensus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
  <div id="imports"></div>
  <script src="assets/templates.js"></script>
  <style>
    .card.included {
      background-color: #d4edda;
      border-color: #c3e6cb;
    }

    .card.excluded {
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }

    label {
      font-weight: 600;
      margin-top: 0.5rem;
      display: block;
    }

    input[type="number"] {
      max-width: 80px;
    }
  </style>
</head>

<body class="bg-light">
  <div id="header"></div>

  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-12 bg-white p-4 rounded shadow-sm">
        <h2 class="mb-4 text-center">Auto-Consensus Review</h2>

        <!-- Confidence Settings -->
        <div class="card mb-4 p-3">
          <h4 class="card-title mb-3">Confidence Level Settings</h4>
          <form id="confidence-form" class="row row-cols-1 row-cols-md-2 g-3">

            <div class="col">
              <h5>Inclusion Criteria</h5>
              <div class="mb-2">
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="inclusion-mode" id="inc-all" value="all" checked>
                  <label class="form-check-label" for="inc-all">Match All</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="inclusion-mode" id="inc-one" value="one">
                  <label class="form-check-label" for="inc-one">Match One</label>
                </div>
              </div>
              <div id="inclusion-fields"></div>
            </div>

            <div class="col">
              <h5>Exclusion Criteria</h5>
              <div class="mb-2">
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="exclusion-mode" id="exc-all" value="all" checked>
                  <label class="form-check-label" for="exc-all">Match All</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="exclusion-mode" id="exc-one" value="one">
                  <label class="form-check-label" for="exc-one">Match One</label>
                </div>
              </div>
              <div id="exclusion-fields"></div>
            </div>

          </form>
        </div>

        <div id="summary" class="alert alert-info mb-4">Loading...</div>
        <div id="cardsContainer"></div>
        <button id="download-btn" class="btn btn-success mt-4">Finish Consensus</button>
      </div>
    </div>
  </div>

  <script>
    let studies = [];
    let preferencesData = {};

    // ---- Helpers ----
    function parseCSVDecision(csvText) {
      if (!csvText || typeof csvText !== "string") return {};
      const lines = csvText.split("\n").map(l => l.trim()).filter(l => l && !l.startsWith("Criteria"));
      const obj = {};
      lines.forEach(line => {
        const [crit, val] = line.split(",").map(x => x.trim());
        obj[crit] = isNaN(parseInt(val)) ? -1 : parseInt(val);
      });
      return obj;
    }

    // ---- Consenso ----
    function calculateConsensus(...values) {
      const valid = values.filter(v => v !== -1 && v !== undefined);
      if (valid.length === 0) return -1;
      if (valid.length === 1) return valid[0];
      if (valid.length === 2) return Math.max(...valid);
      valid.sort((a, b) => a - b);
      return valid[Math.floor(valid.length / 2)];
    }

    function computeConsensusValues(study) {
      const result = {};
      const allKeys = new Set([
        ...Object.keys(study.firstModelDecision || {}),
        ...Object.keys(study.secondModelDecision || {}),
        ...Object.keys(study.thirdModelDecision || {})
      ]);
      allKeys.forEach(key => {
        const f = study.firstModelDecision?.[key] ?? -1;
        const s = study.secondModelDecision?.[key] ?? -1;
        const t = study.thirdModelDecision?.[key] ?? -1;
        result[key] = calculateConsensus(f, s, t);
      });
      return result;
    }

    // ---- Configuração ----
    function getConfidenceConfig() {
      const config = {};
      document.querySelectorAll('#confidence-form input[type=number]').forEach(input => {
        config[input.name] = parseInt(input.value, 10);
      });
      return config;
    }

    function getMatchMode() {
      return {
        inclusionMode: document.querySelector('input[name="inclusion-mode"]:checked')?.value || 'all',
        exclusionMode: document.querySelector('input[name="exclusion-mode"]:checked')?.value || 'all'
      };
    }

    function passesCriteria(output, config) {
      const { inclusionMode, exclusionMode } = getMatchMode();
      const inclusionCriteria = Object.keys(config).filter(k => k.startsWith('IC'));
      const exclusionCriteria = Object.keys(config).filter(k => k.startsWith('EC'));

      let inclusionPass = inclusionCriteria.length === 0 ||
        (inclusionMode === 'all'
          ? inclusionCriteria.every(c => output[c] !== undefined && output[c] >= config[c])
          : inclusionCriteria.some(c => output[c] !== undefined && output[c] >= config[c])
        );

      let exclusionPass = exclusionCriteria.length > 0 &&
        (exclusionMode === 'all'
          ? exclusionCriteria.every(c => output[c] !== undefined && output[c] >= config[c])
          : exclusionCriteria.some(c => output[c] !== undefined && output[c] >= config[c])
        );

      return inclusionPass && !exclusionPass;
    }

    // ---- Form dinâmico ----
    function generateDynamicCriteriaForm() {
      const inclusionContainer = document.getElementById('inclusion-fields');
      const exclusionContainer = document.getElementById('exclusion-fields');
      inclusionContainer.innerHTML = '';
      exclusionContainer.innerHTML = '';

      (preferencesData.inclusionCriteria || []).forEach((crit, idx) => {
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'form-control';
        input.name = `IC${idx + 1}`;
        input.min = 1;
        input.max = 7;
        input.value = 4;

        const label = document.createElement('label');
        label.innerText = crit;
        label.htmlFor = input.name;

        inclusionContainer.appendChild(label);
        inclusionContainer.appendChild(input);
      });

      (preferencesData.exclusionCriteria || []).forEach((crit, idx) => {
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'form-control';
        input.name = `EC${idx + 1}`;
        input.min = 1;
        input.max = 7;
        input.value = 2;

        const label = document.createElement('label');
        label.innerText = crit;
        label.htmlFor = input.name;

        exclusionContainer.appendChild(label);
        exclusionContainer.appendChild(input);
      });

      document.querySelectorAll('#confidence-form input[type=number], input[name="inclusion-mode"], input[name="exclusion-mode"]').forEach(el => {
        el.addEventListener('input', renderStudies);
        el.addEventListener('change', renderStudies);
      });
    }

    // ---- Renderização ----
    function renderStudies() {
      const config = getConfidenceConfig();
      const container = document.getElementById("cardsContainer");
      container.innerHTML = "";

      let included = 0, excluded = 0;

      studies.forEach((study, idx) => {
        const consensus = computeConsensusValues(study);
        const decision = passesCriteria(consensus, config);

        study.userDecision = decision ? "Include" : "Exclude";
        if (decision) included++; else excluded++;

        const rows = Object.keys(consensus).map(criteria => `
          <tr>
            <td>${criteria}</td>
            <td>${study.firstModelDecision?.[criteria] ?? "—"}</td>
            <td>${study.secondModelDecision?.[criteria] ?? "—"}</td>
            <td>${study.thirdModelDecision?.[criteria] ?? "—"}</td>
            <td><strong>${consensus[criteria]}</strong></td>
          </tr>
        `).join('');

        const card = document.createElement("div");
        card.className = `card mb-4 p-3 ${decision ? 'included' : 'excluded'}`;
        card.setAttribute("data-idx", idx);
        card.innerHTML = `
          <h5 class="card-title">${study.title || study.Title}</h5>
          <p><strong>Abstract:</strong> ${study.abstract || study.Abstract}</p>
          <p><strong>Keywords:</strong> ${study.keywords || study.Keywords || "—"}</p>
          <h6 class="mt-3">Model Decisions & Consensus</h6>
          <table class="table table-bordered">
            <thead>
              <tr><th>Criteria</th><th>First Model</th><th>Second Model</th><th>Third Model</th><th>Consensus</th></tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
          <p><strong>Final Decision:</strong> ${study.userDecision}</p>
        `;
        container.appendChild(card);
      });

      document.getElementById("summary").innerText = `Included: ${included} | Excluded: ${excluded}`;
    }

    // ---- Download ZIP ----
    document.getElementById('download-btn').addEventListener('click', () => {
      const config = getConfidenceConfig();
      const included = studies.filter(s => s.userDecision === "Include");
      const excluded = studies.filter(s => s.userDecision === "Exclude");

      const zip = new JSZip();
      const metadata = {
        config,
        inclusionCriteria: preferencesData.inclusionCriteria || [],
        exclusionCriteria: preferencesData.exclusionCriteria || []
      };

      zip.file("metadata.json", JSON.stringify(metadata, null, 2));
      zip.file("included.json", JSON.stringify(included, null, 2));
      zip.file("excluded.json", JSON.stringify(excluded, null, 2));

      localStorage.setItem("finalDecision", {
        "metadata": JSON.stringify(metadata, null, 2),
        "included": JSON.stringify(included, null, 2),
        "excluded": JSON.stringify(excluded, null, 2)
      })


      zip.generateAsync({ type: "blob" }).then(content => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = "consensus-results.zip";
        a.click();
        URL.revokeObjectURL(a.href);
      });
    });

    // ---- Inicialização ----
    window.addEventListener("DOMContentLoaded", () => {
      const raw = localStorage.getItem("excludedStudies");
      if (!raw) {
        alert("No studies found in localStorage.");
        return;
      }
      studies = JSON.parse(raw);

      // parse decisions para objetos
      studies.forEach(study => {
        study.firstModelDecision = parseCSVDecision(study.firstModelDecision);
        study.secondModelDecision = parseCSVDecision(study.secondModelDecision);
        study.thirdModelDecision = parseCSVDecision(study.thirdModelDecision);
      });

      const preferencesRaw = localStorage.getItem("preferencesData");
      if (preferencesRaw) {
        try { preferencesData = JSON.parse(preferencesRaw); }
        catch (e) { console.error("Erro ao parsear preferencesData", e); }
      }

      generateDynamicCriteriaForm();
      renderStudies();
    });
  </script>
</body>

<script>
  $("#imports").load("components/imports.html");
  $("#header").load("components/header.html");
</script>

</html>